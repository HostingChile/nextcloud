version: '3' 

services:
    proxy:
        image: jwilder/nginx-proxy:alpine
        labels:
            - "com.github.jrcs.letsencrypt_nginx_proxy_companion.nginx_proxy=true"
        container_name: nextcloud-proxy
        networks:
            - nextcloud_network
        ports:
            - 80:80
            - 443:443
        volumes:
            - proxy-conf:/etc/nginx/conf.d:rw
            - proxy-vhost:/etc/nginx/vhost.d:rw
            - proxy-html:/usr/share/nginx/html:rw
            - proxy-certs:/etc/nginx/certs:ro
            - /etc/localtime:/etc/localtime:ro
            - /var/run/docker.sock:/tmp/docker.sock:ro
        restart: unless-stopped
  
    letsencrypt:
        image: jrcs/letsencrypt-nginx-proxy-companion
        container_name: nextcloud-letsencrypt
        depends_on:
            - proxy
        networks:
            - nextcloud_network
        volumes:
            - proxy-certs:/etc/nginx/certs:rw
            - proxy-vhost:/etc/nginx/vhost.d:rw
            - proxy-html:/usr/share/nginx/html:rw
            - /etc/localtime:/etc/localtime:ro
            - /var/run/docker.sock:/var/run/docker.sock:ro
        restart: unless-stopped
    
    database:
        image: mariadb
        container_name: nextcloud-database
        networks:
            - nextcloud_network
        volumes:
            - db:/var/lib/mysql
            - /etc/localtime:/etc/localtime:ro
        environment:
            - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
            - MYSQL_DATABASE=${MYSQL_DATABASE}
            - MYSQL_USER=${MYSQL_USER}
            - MYSQL_PASSWORD=${MYSQL_PASSWORD}
        restart: unless-stopped
  
    nextcloud:
        image: nextcloud:latest
        container_name: nextcloud-app
        networks:
            - nextcloud_network
        depends_on:
            - letsencrypt
            - proxy
            - database
        volumes:
            - nextcloud:/var/www/html
            - /etc/localtime:/etc/localtime:ro
        environment:
            - NEXTCLOUD_ADMIN_USER=${NEXTCLOUD_ADMIN_USER}
            - NEXTCLOUD_ADMIN_PASSWORD=${NEXTCLOUD_ADMIN_PASSWORD}
            - MYSQL_DATABASE=${MYSQL_DATABASE}
            - MYSQL_USER=${MYSQL_USER}
            - MYSQL_PASSWORD=${MYSQL_PASSWORD}
            - MYSQL_HOST=database
            - VIRTUAL_HOST=nextcloud.${DOMAIN}
            - LETSENCRYPT_HOST=nextcloud.${DOMAIN}
            - LETSENCRYPT_EMAIL=${EMAIL}
        restart: unless-stopped
        
volumes:
    nextcloud:
    db: 
    proxy-conf:
    proxy-vhost:
    proxy-html:
    proxy-certs:
  
networks:
    nextcloud_network:
        ipam:
            driver: default
            config:
                - subnet: 172.20.0.0/16
